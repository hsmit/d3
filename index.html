<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>D3.js Candlestick Chart</title>
        <script type="text/javascript" src="d3.v3.js"></script>

        <style>
            body {font: 12px Arial;}
            .candle {
                stroke: black; 
                stroke-width: 1;
             }
            .bullish {
                fill: green;
            } 
            .bearish {
                fill: red;
            } 
            svg {
                border: 1px solid #DDD;
            }
            .axis path, .axis line {
                fill: none;
                stroke: grey;
                stroke-width: 1;
                shape-rendering: crispEdges;
            }
            .day {
                fill: grey;
            }
            
            .day path {
                stroke: none;
                
            }
            
            .crosshair {
                stroke: grey;
                stroke-width: 1px;
                stroke-dasharray: 5,3;
                shape-rendering: crispEdges;
            }
              
        </style>        
    </head>
    <body>
        <h1>D3.js Candlestick Chart</h1>
        
        <script type="text/javascript">
           
           
            d3.json("data/30minutes.json", function(data) {
                // dataset from currency exchange
                var dataset = data.result.slice(-100, -1);
                
                // sizes
                var marginRight = 90, marginBottom = 63, space = 4,
                    paddingLeft = 5, paddingRight = 5, paddingTop = 5, paddingBottom = 5,
                    chartWidth = 555, chartHeight = 360,
                    yearOffset = 35,
                    minimumCandleHeight = 0.1,
                    svgWidth = chartWidth + marginRight,
                    svgHeight = chartHeight + marginBottom;

                    
                // format dataset
                dataset.forEach(function(d) {
                    d.L = +d.L;
                    d.H = +d.H;
                    d.O = +d.O;
                    d.C = +d.C;
                    d.V = +d.V;
                    d.BV = +d.BV;
                    d.T = d3.time.format("%Y-%m-%dT%H:%M:%S").parse(d.T);
                    d.bullish = d.O < d.C;
                });

                
                // data analysis   
                var min = d3.min(dataset, function(d) { return  d.L; });
                var max = d3.max(dataset, function(d) { return  d.H; });
                var [minDate, maxDate] = d3.extent(dataset, function(d) { return d.T;});
                var bins = dataset.length;
                var barWidth = (chartWidth/bins) - (space/2);
                var intervalMs = dataset[1].T.getTime() - dataset[0].T.getTime();
                var minDate2 = new Date(minDate.getTime() - intervalMs/2);
                var maxDate2 = new Date(maxDate.getTime() + intervalMs/2);
                
                
                // scales
                var yScale = d3.scale.linear()
                    .domain([min, max]).range([chartHeight, 0]);
                var xScale = d3.time.scale()
                    .domain([minDate2, maxDate2])
                    .range([0, chartWidth]);


                // SVG chart
                var chart = d3.select("body")
                    .append("svg")
                    .attr("width", svgWidth)
                    .attr("height", svgHeight);


                // crosshairs
                var focus = chart.append('g');
                focus.append('line')
                    .attr('id', 'crosshairX')
                    .attr('class', 'crosshair');
                focus.append('line')
                    .attr('id', 'crosshairY')
                    .attr('class', 'crosshair');
                chart.on("mousemove", function() {
                    var [mouseX, mouseY] = d3.mouse(this);
                    focus.select("#crosshairX")
                        .attr("x1", 0)
                        .attr("x2", chartWidth)
                        .attr("y1", mouseY)
                        .attr("y2", mouseY);
                    focus.select("#crosshairY")
                        .attr("x1", mouseX)
                        .attr("x2", mouseX)
                        .attr("y1", 0)
                        .attr("y2", chartHeight);
                });
                
                    
                // draw axis
                // Y axis
                var yAxis = d3.svg.axis()
                    .scale(yScale)
                    .orient("right")
                    .ticks(5)
                    .tickFormat(d3.format(".8f"));
                chart.append("g")
                    .attr("transform", "translate(" + (paddingLeft + chartWidth + paddingRight)+ ", " + paddingTop + " )")
                    .style("fill", "black")	
                    .attr("class", "axis")	
                    .call(yAxis);
                // X axis - minutes
                var xAxisTime = d3.svg.axis()
                    .scale(xScale)
                    .orient("bottom")
                    .ticks(8)
                    .tickFormat(d3.time.format("%H:%M"));
                chart.append("g")
                    .attr("transform", "translate("+paddingLeft+", " + (chartHeight+10)+ ")")
                    .style("fill", "black")	
                    .attr("class", "axis")	
                    .call(xAxisTime);
                // X axis - date
                var xAxisDate = d3.svg.axis()
                    .scale(xScale)
                    .orient("bottom")
                    .ticks(d3.time.days, 1)
                    .tickFormat(d3.time.format("%Y-%m-%d"));
                chart.append("g")
                    .attr("transform", "translate("+paddingLeft+", " + (chartHeight+yearOffset)+ ")")
                    .attr("class", "axis day")	
                    .call(xAxisDate);
                    

                // shadow lines          
                chart.selectAll("line.shadow")
                    .data(dataset)
                    .enter()
                    .append("line")
                        .attr("class", "shadow")
                        .attr("transform", "translate(" + paddingLeft + ", " + paddingTop + ")")
                        .attr("x1", function(d) {return xScale(d.T);})
                        .attr("y1", function(d) {return yScale(d.H);})
                        .attr("x2", function(d) {return xScale(d.T);})
                        .attr("y2", function(d) {return yScale(d.L);})
                        .attr("stroke", "black")
                        .attr("stroke-width", 1);


                // candles
                chart.selectAll("rect.candle")
                    .data(dataset)
                    .enter()
                    .append("rect")
                        .attr("class", function(d) { return "candle " + (d.bullish ? "bullish" : "bearish");})
                        .attr("transform", "translate(" + paddingLeft + ", " + paddingTop + ")")
                        .attr("x", function(d) {return xScale(d.T)-(barWidth/2);})
                        .attr("y", function(d, i) {return Math.min(yScale(+d.O), yScale(+d.C)); })
                        .attr("height", function(d) {
                            return Math.abs(yScale(d.O) - yScale(d.C)) + minimumCandleHeight; 
                        })
                        .attr("width", barWidth);
            });
        </script>
        <p>Hannes Smit</p>
    </body>
</html>
